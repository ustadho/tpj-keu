/*
 * frmRptKasir.java
 *
 * Created on November 30, 2005, 7:04 PM
 */

package tpjkeuangan;

import java.sql.Connection;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import javax.swing.DefaultListModel;
import javax.swing.JOptionPane;
import net.sf.jasperreports.engine.JRException;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.util.JRLoader;
import net.sf.jasperreports.view.JasperViewer;

/**
 *
 * @author  root
 */
public class FrmRptLain extends javax.swing.JInternalFrame {
    
    private Connection conn;
    private String sKodeJenis="";
    private String sUser="";
    private DefaultListModel modelJenis, modelTrx;
    private ListRsbm lst;
    
    public void setCon(Connection con){
        conn=con;
    }
    /** Creates new form frmRptKasir */
    public FrmRptLain() {
        initComponents();
    }

    void setUserName(String sUserName) {
        sUser="";
    }
    
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnPreview = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        jList1 = new javax.swing.JList();
        jLabel1 = new javax.swing.JLabel();
        btnTambahItem1 = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jDateAkhir = new org.jdesktop.swingx.JXDatePicker();
        lblTglAkhir = new javax.swing.JLabel();
        lblTglAwal = new javax.swing.JLabel();
        jDateAwal = new org.jdesktop.swingx.JXDatePicker();
        jLabel24 = new javax.swing.JLabel();
        txtJenisBayar = new javax.swing.JTextField();
        lblJenisBayar = new javax.swing.JLabel();

        setBackground(new java.awt.Color(204, 204, 255));
        setClosable(true);
        setTitle("Laporan Lain");
        addInternalFrameListener(new javax.swing.event.InternalFrameListener() {
            public void internalFrameActivated(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameClosed(javax.swing.event.InternalFrameEvent evt) {
                formInternalFrameClosed(evt);
            }
            public void internalFrameClosing(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameDeactivated(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameDeiconified(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameIconified(javax.swing.event.InternalFrameEvent evt) {
            }
            public void internalFrameOpened(javax.swing.event.InternalFrameEvent evt) {
                formInternalFrameOpened(evt);
            }
        });
        getContentPane().setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        btnPreview.setIcon(new javax.swing.ImageIcon(getClass().getResource("/image/Icon/preview.png"))); // NOI18N
        btnPreview.setMnemonic('P');
        btnPreview.setText("Preview");
        btnPreview.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        btnPreview.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        btnPreview.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPreviewActionPerformed(evt);
            }
        });
        getContentPane().add(btnPreview, new org.netbeans.lib.awtextra.AbsoluteConstraints(503, 162, 90, 100));

        jList1.setModel(new javax.swing.AbstractListModel() {
            String[] strings = { "Daftar Nota per Kota", "Rekap per kapal ~ tgl. berangkat", "Detail penerimaan pembayaran" };
            public int getSize() { return strings.length; }
            public Object getElementAt(int i) { return strings[i]; }
        });
        jList1.addListSelectionListener(new javax.swing.event.ListSelectionListener() {
            public void valueChanged(javax.swing.event.ListSelectionEvent evt) {
                jList1ValueChanged(evt);
            }
        });
        jScrollPane1.setViewportView(jList1);

        getContentPane().add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(7, 77, 680, 80));

        jLabel1.setFont(new java.awt.Font("Tahoma", 1, 11));
        jLabel1.setText("Pilih Jenis Laporan");
        getContentPane().add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(8, 63, 280, -1));

        btnTambahItem1.setIcon(new javax.swing.ImageIcon(getClass().getResource("/image/Icon/Exit_1.png"))); // NOI18N
        btnTambahItem1.setText("Tutup");
        btnTambahItem1.setToolTipText("Tutup aplikasi pembayaran");
        btnTambahItem1.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
        btnTambahItem1.setVerticalTextPosition(javax.swing.SwingConstants.BOTTOM);
        btnTambahItem1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnTambahItem1ActionPerformed(evt);
            }
        });
        getContentPane().add(btnTambahItem1, new org.netbeans.lib.awtextra.AbsoluteConstraints(595, 162, 90, 100));

        jLabel2.setIcon(new javax.swing.ImageIcon(getClass().getResource("/image/Icon/report_header.png"))); // NOI18N
        jLabel2.setText("jLabel2");
        getContentPane().add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(6, 5, 680, -1));

        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());
        jPanel1.add(jDateAkhir, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 30, 130, 20));

        lblTglAkhir.setText("Sampai");
        jPanel1.add(lblTglAkhir, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 30, 60, 20));

        lblTglAwal.setText("Dari");
        jPanel1.add(lblTglAwal, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 10, 60, 20));
        jPanel1.add(jDateAwal, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 10, 130, 20));

        jLabel24.setText("Jenis");
        jPanel1.add(jLabel24, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, 70, 20));

        txtJenisBayar.setFont(new java.awt.Font("Dialog", 0, 12));
        txtJenisBayar.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0), 1, true));
        txtJenisBayar.setDisabledTextColor(new java.awt.Color(153, 153, 153));
        txtJenisBayar.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                txtJenisBayarKeyPressed(evt);
            }
            public void keyReleased(java.awt.event.KeyEvent evt) {
                txtJenisBayarKeyReleased(evt);
            }
        });
        jPanel1.add(txtJenisBayar, new org.netbeans.lib.awtextra.AbsoluteConstraints(70, 50, 50, 22));

        lblJenisBayar.setFont(new java.awt.Font("Dialog", 0, 12));
        lblJenisBayar.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(0, 0, 0), 1, true));
        jPanel1.add(lblJenisBayar, new org.netbeans.lib.awtextra.AbsoluteConstraints(120, 50, 360, 22));

        getContentPane().add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(8, 161, 490, 100));

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-701)/2, (screenSize.height-307)/2, 701, 307);
    }// </editor-fold>//GEN-END:initComponents

    private void formInternalFrameClosed(javax.swing.event.InternalFrameEvent evt) {//GEN-FIRST:event_formInternalFrameClosed
        Utama.isRptLainOn=false;
    }//GEN-LAST:event_formInternalFrameClosed

    private void formInternalFrameOpened(javax.swing.event.InternalFrameEvent evt) {//GEN-FIRST:event_formInternalFrameOpened
        lst = new ListRsbm();
        lst.setVisible(false);
        lst.setSize(500, 200);
        lst.con = conn;
            
        modelTrx=new DefaultListModel();
        jList1.setSelectedIndex(0);
        
        jDateAwal.setFormats("dd-MM-yyyy");
        jDateAkhir.setFormats("dd-MM-yyyy");
        
    }//GEN-LAST:event_formInternalFrameOpened
                    
    private void btnPreviewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPreviewActionPerformed
        
        udfPrint();
        
    }//GEN-LAST:event_btnPreviewActionPerformed

    private void btnTambahItem1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnTambahItem1ActionPerformed
        this.dispose();
    }//GEN-LAST:event_btnTambahItem1ActionPerformed

    private void jList1ValueChanged(javax.swing.event.ListSelectionEvent evt) {//GEN-FIRST:event_jList1ValueChanged
        // TODO add your handling code here:
        jLabel24.setVisible(false);
        txtJenisBayar.setVisible(false);
        lblJenisBayar.setVisible(false);
        
        switch(jList1.getSelectedIndex()){
            case 0:{
                jLabel24.setVisible(true); jLabel24.setText("Kota");
                txtJenisBayar.setVisible(true);
                lblJenisBayar.setVisible(true);
            }
            case 1:{
                lblTglAwal.setText("Tgl. Awal");
                break;
            }
            case 2:{
                jLabel24.setVisible(true); jLabel24.setText("Jenis");
                txtJenisBayar.setVisible(true);
                lblJenisBayar.setVisible(true);
            }
            
        }
    }//GEN-LAST:event_jList1ValueChanged

private void txtJenisBayarKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtJenisBayarKeyPressed
// TODO add your handling code here:
}//GEN-LAST:event_txtJenisBayarKeyPressed

private void txtJenisBayarKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_txtJenisBayarKeyReleased
try {
            String sCari = txtJenisBayar.getText();
            switch(evt.getKeyCode()) {
                
                case java.awt.event.KeyEvent.VK_ENTER : {
                    if (lst.isVisible()){
                        Object[] obj = lst.getOResult();
                        if (obj.length > 0) {
                            txtJenisBayar.setText(obj[0].toString());
                            lblJenisBayar.setText(obj[1].toString());
                            //lblAlamatToko.setText(obj[2].toString());
                            lst.setVisible(false);
                        }
                    }
                    break;
                }
                case java.awt.event.KeyEvent.VK_DELETE: {
                    lst.setFocusable(true);
                    lst.requestFocus();
                    
                    break;
                }
                case java.awt.event.KeyEvent.VK_ESCAPE: {
                    lst.setVisible(false);
                    txtJenisBayar.setText("");
                    lblJenisBayar.setText("");
                }
                case java.awt.event.KeyEvent.VK_DOWN: {
                    if (lst.isVisible()){
                        
                        lst.setFocusableWindowState(true);
                        lst.setVisible(true);
                        lst.requestFocus();
                    }
                    break;
                }
                default : {
                    if(!evt.getKeyText(evt.getKeyCode()).equalsIgnoreCase("Up") || !evt.getKeyText(evt.getKeyCode()).equalsIgnoreCase("F2")){
//                        if(txtSupplier.getText().trim().equalsIgnoreCase("")){
//                            JOptionPane.showMessageDialog(this, "Silakan isi supplier terlebih dulu!");
//                            txtSupplier.requestFocus();
//                            return;
//                        }   
                        String sQry="";
                        
                        if(jList1.getSelectedIndex()==0)
                            sQry="select kode_kota, nama_kota from kota order by nama_kota";
                        else if(jList1.getSelectedIndex()==2)
                            sQry="select coalesce(kode, '') as kode, coalesce(alat_pembayaran,'') as Jenis_pembayaran " +
                                "from nota_alat_pembayaran where (coalesce(kode, '')||coalesce(alat_pembayaran,'')) " +
                                "iLike '%"+sCari+"%' order by 2";
                        
                        
                        System.out.println(sQry);
                        lst.setSQuery(sQry);
                        
                        lst.setBounds(this.getX()+this.jPanel1.getX()+ this.txtJenisBayar.getX()+Utama.iLeft+17, 
                                this.getY()+this.jPanel1.getY()+this.txtJenisBayar.getY() + txtJenisBayar.getHeight()+Utama.iTop+77, 
                                txtJenisBayar.getWidth()+lblJenisBayar.getWidth()+5,
                                150);
                        lst.setFocusableWindowState(false);
                        lst.setTxtCari(txtJenisBayar);
                        lst.setLblDes(new javax.swing.JLabel[]{lblJenisBayar});
                        lst.setColWidth(0, txtJenisBayar.getWidth());
                        lst.setColWidth(1, lblJenisBayar.getWidth());
                        if(lst.getIRowCount()>0){
                            lst.setVisible(true);
                            requestFocusInWindow();
                            txtJenisBayar.requestFocus();
                        } else{
                            txtJenisBayar.setText("");
                            lblJenisBayar.setText("");
                            lst.setVisible(false);
                            txtJenisBayar.requestFocus();
                        }
                    }
                    break;
                }
            }
        } catch (SQLException se) {System.out.println(se.getMessage());}
}//GEN-LAST:event_txtJenisBayarKeyReleased

    void setUser(String sUser) {
        this.sUser=sUser;
    }

    private void udfPrint() {
        try {
            HashMap reportParam = new HashMap();
            JasperReport jasperReport = null;
            reportParam.put("serial_kapal", "");
//            reportParam.put("kota_tujuan", lblKotaTujuan.getText());
//            reportParam.put("kapal_berangkat", sKapalBerangkat);

            switch(jList1.getSelectedIndex()){
                case 0:{ //Umum semua nota per Kapal berangkat
                    reportParam.put("tanggal1", new SimpleDateFormat("yyyy-MM-dd").format(jDateAwal.getDate()));
                    reportParam.put("tanggal2", new SimpleDateFormat("yyyy-MM-dd").format(jDateAkhir.getDate()));
                    jasperReport = (JasperReport) JRLoader.loadObject(getClass().getResourceAsStream("Reports/rekap_per_kapal_periodik.jasper"));
                    JasperPrint print = JasperFillManager.fillReport(jasperReport, reportParam, conn);
                    print.setOrientation(jasperReport.getOrientation());
                    if(print.getPages().isEmpty()){
                        JOptionPane.showMessageDialog(this, "Data tidak ditemukan");
                        return;
                    }
                    JasperViewer.viewReport(print, false);
                    break;
                }
                
                case 1:{ //Umum semua nota per Kapal berangkat
                    reportParam.put("tanggal1", new SimpleDateFormat("yyyy-MM-dd").format(jDateAwal.getDate()));
                    reportParam.put("tanggal2", new SimpleDateFormat("yyyy-MM-dd").format(jDateAkhir.getDate()));
                    jasperReport = (JasperReport) JRLoader.loadObject(getClass().getResourceAsStream("Reports/rekap_per_kapal_periodik.jasper"));
                    JasperPrint print = JasperFillManager.fillReport(jasperReport, reportParam, conn);
                    print.setOrientation(jasperReport.getOrientation());
                    if(print.getPages().isEmpty()){
                        JOptionPane.showMessageDialog(this, "Data tidak ditemukan");
                        return;
                    }
                    JasperViewer.viewReport(print, false);
                    break;
                }
                case 2:{ //Detail penerimaan
                    reportParam.put("tanggal1", new SimpleDateFormat("yyyy-MM-dd").format(jDateAwal.getDate()));
                    reportParam.put("tanggal2", new SimpleDateFormat("yyyy-MM-dd").format(jDateAkhir.getDate()));
                    reportParam.put("jenis_pembayaran", txtJenisBayar.getText());
                    reportParam.put("header", "Pembayaran detail per tanggal "+ 
                            new SimpleDateFormat("dd-MM-yyyy").format(jDateAwal.getDate()) + " sampai dengan "+
                            new SimpleDateFormat("dd-MM-yyyy").format(jDateAkhir.getDate()) );
                    
                    jasperReport = (JasperReport) JRLoader.loadObject(getClass().getResourceAsStream("Reports/nota_pembayaran_detail2.jasper"));
                    JasperPrint print = JasperFillManager.fillReport(jasperReport, reportParam, conn);
                    print.setOrientation(jasperReport.ORIENTATION_PORTRAIT);
                    if(print.getPages().isEmpty()){
                        JOptionPane.showMessageDialog(this, "Data tidak ditemukan");
                        return;
                    }
                    JasperViewer.viewReport(print, false);
                    break;
                }
//                default:{
//                    jasperReport = (JasperReport) JRLoader.loadObject(getClass().getResourceAsStream("Reports/nota_daftar_tagihan_per_kapal_per_tgl_berangkat.jasper"));
//                    JasperPrint print = JasperFillManager.fillReport(jasperReport, reportParam, conn);
//                    print.setOrientation(jasperReport.ORIENTATION_PORTRAIT);
//                    JasperViewer.viewReport(print, false);
//                    break;
//                }
            }



        } catch (JRException je) {
            System.out.println(je.getMessage());
        }
        
    }
    
    /**
     * @param args the command line arguments
     */
/*    public static void main(String args[]) {
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                new frmRptKasir().setVisible(true);
            }
        });
    }
 */
    // Variables declaration - do not modify//GEN-BEGIN:variables
    public javax.swing.JButton btnPreview;
    public javax.swing.JButton btnTambahItem1;
    public org.jdesktop.swingx.JXDatePicker jDateAkhir;
    public org.jdesktop.swingx.JXDatePicker jDateAwal;
    public javax.swing.JLabel jLabel1;
    public javax.swing.JLabel jLabel2;
    public javax.swing.JLabel jLabel24;
    public javax.swing.JList jList1;
    public javax.swing.JPanel jPanel1;
    public javax.swing.JScrollPane jScrollPane1;
    public javax.swing.JLabel lblJenisBayar;
    public javax.swing.JLabel lblTglAkhir;
    public javax.swing.JLabel lblTglAwal;
    public javax.swing.JTextField txtJenisBayar;
    // End of variables declaration//GEN-END:variables
    
}
